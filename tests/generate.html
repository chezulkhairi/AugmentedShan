<!doctype html>
<html>
	<head>
		
		<script src="../promise-6.0.0.min.js"></script>
		<script src="../jsfeat/build/jsfeat.js"></script>
		<script src="dat.gui.min.js"></script>
		<script src="squareDetect.js"></script>
		<script src="squareMatch.js"></script>
		<script>
			var pts = {};
			var db = [];
			// non zero bits count
			function popcnt32(n) {
			    n -= ((n >> 1) & 0x55555555);
			    n = (n & 0x33333333) + ((n >> 2) & 0x33333333);
			    return (((n + (n >> 4))& 0xF0F0F0F)* 0x1010101) >> 24;
			}
			function hammingDist(a1,a2){
				return popcnt32(a1[0]^a2[0]) + popcnt32(a1[1]^a2[1]) + popcnt32(a1[2]^a2[2]);
			}
			function bestMatch(vector){
				var curBest = null;
				var curBestScore = 32*3;
				for (key in pts) {
					var nscore = hammingDist(vector,pts[key]);
					if(nscore<curBestScore){
						curBest=key;
						curBestScore=nscore;
					}
				};
				return [curBest,curBestScore];
			}
			function bestMatches(vector){
				var scores=[]
				for (key in pts) {
					var nscore = hammingDist(vector,pts[key]);
					scores.push({
						score:nscore,
						key:key
					});
				};
				scores.sort(function(a,b){
					return a.score - b.score;
				});
				return scores.slice(0,10);
			}
			function scoreAt(x,y){
				return scoreSquare({center:{x:(x*10+3)*2,y:(y*10+5)*2}, size:10*2},imageData,10,true);
			}

			window.addEventListener('load',function(){
				var tcanvas = document.createElement('canvas');
				tcanvas.width = 520*2;
				tcanvas.height = 340*2;
				var ctx = tcanvas.getContext('2d');
				var img = document.getElementById('testImg');
				ctx.drawImage(img, 0,0,tcanvas.width,tcanvas.height);
				var imageData = ctx.getImageData(0,0,tcanvas.width,tcanvas.height);
				window.imageData = imageData;

				var dcanvas = document.getElementById('drawCanvas');
				dcanvas.width=tcanvas.width;
				dcanvas.height=tcanvas.height;
				var dctx = dcanvas.getContext('2d');
				dctx.putImageData(imageData,0,0);
				
				for (var x = 1; x < 51; x++) {
					for (var y = 1; y < 33; y++) {
						if(y >=6 && y <= 15){
							if(x >= 15 && x<=26) continue;
							if(x >= 34 && x<=45) continue;
						}
						if(y >=21 && y <= 30){
							if(x >= 11 && x<=22) continue;
							if(x >= 30 && x<=41) continue;
						}
						dctx.fillRect((x*10+3)*2 -1, (y*10+5)*2 -1,2,2);
						pts[[x,y]]=scoreSquare({center:{x:(x*10+3)*2,y:(y*10+5)*2}, size:10*2},imageData,10,true);
						db[db.length] = [x,y,pts[[x,y]]];
					};
				};
				console.log(JSON.stringify(db));
			})
		</script>
	<body>
		<canvas id="drawCanvas" width="640" height="360"></canvas>
		<img id="testImg" src="fullshan.png">
	</body>
</html>